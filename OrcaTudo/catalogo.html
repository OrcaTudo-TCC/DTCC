<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo</title>
    <script src="https://kit.fontawesome.com/449a3898b7.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/catalogo.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="icon" href="imagens/Logo1.png" type="image/png">

</head>
<body>

    <header>
        <div class="logo">
            <img src="imagens/Logo1.png" alt="Logo OrçaTudo">
        </div>

        <div class="search-bar">
            <div>
                <input id="input" type="text" placeholder="O que você procura na Orça Tudo?">
                <i class="fas fa-search" id="search"></i>
            </div>
            <ul class="sugestoes">
            </ul>
        </div>

        <nav>
            <ul>
                <li><a href="catalogo.html">Catálogo</a></li>
                <li><a id="dashboard">Dashboard</a></li>
            </ul>
        </nav>

        <div class="icons">
            <p id="cadastro">Cadastre-se</p>
            <p id="login">Faça login</p>
            <div class="user-menu">
                <i class="far fa-user" id="user-icon"></i>
                <div class="dropdown-menu" id="dropdown-menu">
                    <a id="perfil">Perfil</a>
                    
                    <a id="logout">Sair da Conta</a>
                </div>
            </div>
            <i class="fas fa-shopping-cart" id="cart"></i>
        </div>
    </header>
    

    <container>


        <div class="mainContent">


              

              <div id="main" >
                            <section class="ordenar-section">
                <span>Produtos em destaque</span>

              </section>
                <section class="catalogo-section">
                  <!-- Filtro -->
                  <div class="filtro-container">
                    <label for="filtro-categoria">Filtrar por Categoria</label>
                    <select id="filtro-categoria" class="filtro-selecao">
                      <!-- <option value="" disabled selected>Selecione uma categoria</option> -->
                    </select>
                  </div>

                  <div class="filtro-container">
                    <label for="filtro">Filtrar por Subcategoria</label>
                    <select id="filtro-subcategoria" class="filtro-selecao">
                      <option value="" disabled selected>Selecione subcategoria</option>
                    </select>
                  </div>

                  <div class="filtro-container">
                    <label for="filtro">Filtrar por Categoria Específica</label>
                    <select id="filtro-final" class="filtro-selecao">
                      <option value="" disabled selected>Selecione categoria final</option>
                    </select>
                  </div>
                
                
    
                    
                </section>
                <div class="results">12345 Resultados encontrados</div>
                <section class="produto-section">

                  <div class="produto-card">
                      <img src="https://cdn.leroymerlin.com.br/products/carrinho_de_mao_em_aco_carbono_pneu_e_camara_chapa_26mm_45l_1571958082_5aac_300x300.jpg" alt="Produto" />
                      <h3> Carrinho De Mão Em Aço </h3>
                      <p class="preco">R$ 189,91</p>
                      <p class="categoria"> Ferramentas e Equipamentos</p>
                      <p class="subcategoria">Carrinhos de Mão</p>
                    </div>
                    
              
                  <!-- repete os cards -->
                  
                  <div class="produto-card">
                    <img src="https://cdn.leroymerlin.com.br/products/betoneira_400l_1_traco_max_mono_127v_csm_92016435_f57f_600x600.jpg" alt="Produto" />
                    <h3> Betoneira 400L 1 Traço </h3>
                    <p class="preco">R$ 4.589,00</p>
                    <p class="categoria"> Categoria </p>
                    <p class="subcategoria"> Sub Categoria </p>
                  </div>
                  
                  <!-- <div class="produto-card">
                    <img src="https://cdn.leroymerlin.com.br/products/trena_manual_5mx19mm_460610_dexter_91716401_b391_600x600.jpg" alt="Produto" />
                    <h3> Trena Manual 5 metros </h3>
                    <p class="preco">R$  29,90</p>
                    <p class="categoria"> Categoria </p>
                    <p class="subcategoria"> Sub Categoria </p>
                  </div>
                  
                  <div class="produto-card">
                    <img src="imagens/placeholder.jpg" alt="Produto" />
                    <h3> Nome Produto  </h3>
                    <p class="preco">R$ 00,00</p>
                    <p class="categoria"> Categoria </p>
                    <p class="subcategoria"> Sub Categoria </p>
                  </div>
                  
                  <div class="produto-card">
                    <img src="imagens/placeholder.jpg" alt="Produto" />
                    <h3> Nome Produto  </h3>
                    <p class="preco">R$ 00,00</p>
                    <p class="categoria"> Categoria </p>
                    <p class="subcategoria"> Sub Categoria </p>
                  </div>
                  
                  <div class="produto-card">
                    <img src="imagens/placeholder.jpg" alt="Produto" />
                    <h3> Nome Produto  </h3>
                    <p class="preco">R$ 00,00</p>
                    <p class="categoria"> Categoria </p>
                    <p class="subcategoria"> Sub Categoria </p>
                  </div>
                  
                  <div class="produto-card">
                    <img src="imagens/placeholder.jpg" alt="Produto" />
                    <h3> Nome Produto  </h3>
                    <p class="preco">R$ 00,00</p>
                    <p class="categoria"> Categoria </p>
                    <p class="subcategoria"> Sub Categoria </p>
                  </div>
                  
                  <div class="produto-card">
                    <img src="imagens/placeholder.jpg" alt="Produto" />
                    <h3> Nome Produto  </h3>
                    <p class="preco">R$ 00,00</p>
                    <p class="categoria"> Categoria </p>
                    <p class="subcategoria"> Sub Categoria </p>
                  </div>
                  
                  <div class="produto-card">
                    <img src="imagens/placeholder.jpg" alt="Produto" />
                    <h3> Nome Produto  </h3>
                    <p class="preco">R$ 00,00</p>
                    <p class="categoria"> Categoria </p>
                    <p class="subcategoria"> Sub Categoria </p>
                  </div> -->
                  

                  
                </section>
              </div>

              
    </container>



    <footer>
      <div class="footer-container">
          <div class="footer-section">
              <img src="imagens/Logo.png" alt="OrçaTudo Logo" class="footer-logo">
          </div>
          <div class="footer-section">
              <h3>Ideal Para</h3>
              <ul>
                  <li>Engenheiros Civis</li>
                  <li>Construtoras</li>
                  <li>Orçamentistas</li>
              </ul>
          </div>
          <div class="footer-section">
              <h3>Funcionalidades</h3>
              <ul>
                  <li>Cotação de Preços</li>
                  <li>Gestão de Orçamentos</li>
                  <li>Comparação de Materiais</li>
              </ul>
          </div>
          <div class="footer-section">
              <h3>Recursos</h3>
              <ul>
                  <li>Lista de Fornecedores</li>
                  <li>Simulação de Custos</li>
                  <li>Dashboard Interativo</li>
              </ul>
          </div>
          <div class="footer-section">
              <h3>Sobre</h3>
              <ul>
                  <li><a href="#">Sobre o OrçaTudo</li>
                  <li><a href="#">Contato</a></li>
              </ul>
          </div>
      </div>
      <div class="footer-bottom">
          <p>© 2025 OrçaTudo. Todos os direitos reservados | Política de Privacidade | Termos de Serviço</p>
      </div>
  </footer>
  

  <script src="js/categoria.js" ></script>
  <script src="js/subcategoria.js"></script>
  <script src="js/SubcategoriaFinal.js"></script>
  <script src="js/produto.js"></script>
  <!--Script responsável por realizar integração das categorias(principal)-->
  <script>
      var select = document.getElementById('filtro-categoria');
      var selectSub = document.getElementById('filtro-subcategoria');
      var selectFinal = document.getElementById('filtro-final');

    
    document.addEventListener('DOMContentLoaded', async ()=>{
      await inicializarSelects()

      let produtos;
      params = new URLSearchParams(window.location.search);
      if(params.get('search')  == null){
        produtos = await todosProdutos();
        renderizarProdutos(produtos.flat());
      }else{
        produtos = await produtoNomeLike(params.get('search'));
        renderizarProdutos(produtos);
      }

    })
  </script>

  <!--Scrpit para renderizar produtos-->
  <script>
    async function renderizarProdutos(produtos){
      params = new URLSearchParams(window.location.search);
      const results = document.getElementsByClassName('results')[0];
      if(params.get('search')  == null){
        results.innerText = produtos.length +" Resultados encontrados"
      }else{
        results.innerText = produtos.length + " resultados para pesquisa '"+ params.get('search')+ "'";
      }

      const section = document.getElementsByClassName('produto-section')[0];
      if(produtos.length === 0){
        section.innerHTML = "";
      }
      produtos.forEach(produto =>{
        console.log("dentro do foreach renderizar, produto: ", produto)

        section.innerHTML = "";
        let  div = document.createElement('div');
        div.classList.add('produto-card');
        div.addEventListener('click', ()=> {
          window.location = "cotacao.html?produto="+ produto.id;
        })
        let img = document.createElement('img');
        const base64 = produto.imagem;
        const contentType = "image/png"; // ou "image/jpeg", conforme o caso
        const dataUrl = `data:${contentType};base64,${base64}`;
        img.src = dataUrl
        div.appendChild(img);
        let h3Nome = document.createElement('h3');
        h3Nome.innerText = produto.nome;
        div.appendChild(h3Nome);
        let preco = document.createElement('p');
        preco.classList.add('preco');
        preco.innerText = "R$ "+ produto.preco
        div.appendChild(preco);
        let categoria = document.createElement('p');
        categoria.classList.add('categoria');
        categoria.innerText = produto.subcategoriaFinal.subcategoria.categoria.nome;
        div.appendChild(categoria);
        let subcategoria = document.createElement('p');
        subcategoria.classList.add('subcategoria');
        subcategoria.innerText = produto.subcategoriaFinal.subcategoria.nome;
        div.appendChild(subcategoria);
        section.appendChild(div)
        console.log("renderizou produto: ", produto)

      })

    }

 </script>

  <!--script responsável por buscar todos os produtos ao inicar página-->
  <script>
    async function todosProdutos() {
      let categorias = await getCategoria();
      let subcategorias = await Promise.all(categorias.map(cate => getSubcategoria(cate.nome)));
      console.log("subcategorias: ",subcategorias)
      let categoriasFinal = await Promise.all(
        subcategorias.flat().map(sub => getSubcategoriafinal(sub.nome))
      );
      console.log("categorias finais: ",categoriasFinal)

      const promessas = categoriasFinal
        .flat()
        .filter(final => final && typeof final.nome === 'string')
        .map(async final => {
          const resultado = await getProdutoByCategoriaFinal(final.nome);
          console.log("Resultado de", final.nome, "=>", resultado);
          return resultado;
        });

      const produtos = await Promise.all(promessas);
      console.log("Produtos:", produtos);
      return produtos
    }
  </script>
  <!--script para retornar os produtos conforme os selects selecionados-->
  <script>
    async function produtosSelect(nomeCategoria , nomeSubcategoria , nomeSubcategoriaFinal) {
      let categoria;
      let subcategoria;
      let subFinal;
      let produtos = null;
      console.log("nomeCategoria:", nomeCategoria);
      console.log("nomeSubcategoria:", nomeSubcategoria);
      console.log("nomeSubcategoriaFinal:", nomeSubcategoriaFinal);
      try {
        if(typeof nomeCategoria !== "string" || typeof nomeSubcategoria !== "string" || typeof nomeSubcategoriaFinal !== "string"){
          throw new Error("O nome da categoria, subcategoria, subcategoriafinal precisam ser do tipo String");
        }
        if(nomeCategoria.trim() !== "" && nomeSubcategoria.trim() !== "" && nomeSubcategoriaFinal.trim() !== "" ){
          //bloco caso os três selects tenham sido selecionados
          

          produtos = await getProdutoByCategoriaFinal(nomeSubcategoriaFinal);
        }else if(nomeCategoria.trim() !== "" && nomeSubcategoria.trim() !== "" && nomeSubcategoriaFinal.trim() === ""){
          //bloco caso apenas categoria e subcategoria tenham sido selecionados
          
          subFinal = await getSubcategoriafinal(nomeSubcategoria);
          produtos = await Promise.all( subFinal.map(final => getProdutoByCategoriaFinal(final.nome)))
        }else if(nomeCategoria.trim() !== "" && nomeSubcategoria.trim() === "" && nomeSubcategoriaFinal.trim() === ""){
          //bloco caso apenas categoria tenha sido selecionada
          
          subcategoria = await getSubcategoria(nomeCategoria);
          console.log("teste",subcategoria);
          subcategoriaFinal = await Promise.all(subcategoria.map(sub => getSubcategoriafinal(sub.nome)));
          produtos = await Promise.all(subcategoriaFinal.flat().map(final => getProdutoByCategoriaFinal(final.nome)));
        }else{
          console.log("nenhum select")
        }
        console.log("produtosSelect rodou!", produtos)
        return produtos;
      } catch (error) {
        console.log("erro na funcão produtoSelect: "+ error);
      }
    }
  </script>
  <!--Script responsável pela inicialização dos selects-->
  <script>
    async function inicializarSelects() {
      let categorias;
      let subcategorias;
      let categoriasFinal;
      categorias = await getCategoria();
      console.log(categorias)

      //colocando as categorias existentes na página
      optionSelected = document.createElement('option');
      optionSelected.value = "";
      optionSelected.disabled = true;
      optionSelected.selected = true;
      optionSelected.innerText = 'Selecione uma categoria';
      select.appendChild(optionSelected);
      categorias.forEach(categoria => {
        option = document.createElement('option');
        option.value = categoria.nome;
        option.innerText = categoria.nome;
        select.appendChild(option);
      });

      //Adicionando eventListener para realizar nova busca quando é alterado o valor do select categoria
      select.addEventListener('change', async ()=>{
        //resetando o conteúdo dos selects dependentes
        
        // selectSub.innerHTML = '<option value= "" disabled selected>Selecione subcategoria</option>';
        selectSub.innerHTML = "";
        optionSelected = document.createElement('option');
        optionSelected.value = "";
        optionSelected.disabled = true;
        optionSelected.selected = true;
        optionSelected.innerText = "Selecione subcategoria"
        selectSub.appendChild(optionSelected);
        // selectFinal.innerHTML = '<option value="" disabled selected>Selecione categoria final</option>';
        selectFinal.innerHTML = "";
        optionSelected = document.createElement('option');
        optionSelected.value = "";
        optionSelected.disabled = true;
        optionSelected.selected = true;
        optionSelected.innerText = "Selecione categoria final"

        selectFinal.appendChild(optionSelected);

        if(!select.value !== "" ){
          subcategorias = await getSubcategoria(select.value);
          console.log(subcategorias);
          subcategorias.forEach(subcategoria => {
  
            option = document.createElement('option');
            option.value = subcategoria.nome;
            option.innerText = subcategoria.nome;
            selectSub.appendChild(option);
          })
        }
        prt = await produtosSelect(select.value, selectSub.value , selectFinal.value);
        renderizarProdutos(prt.flat());
      })

      //Adicionando eventListener para realizar busca quando ocorrer alteração subcategoria
      selectSub.addEventListener('change', async ()=>{
        // selectFinal.innerHTML = '<option value="" disabled selected>Selecione categoria final</option>';
        selectFinal.innerHTML = "";
        optionSelected = document.createElement('option');
        optionSelected.value = "";
        optionSelected.disabled = true;
        optionSelected.selected = true;
        optionSelected.innerText = "Selecione categoria final"
        selectFinal.appendChild(optionSelected);
        if(!selectSub.value !== ""){

          categoriasFinal = await getSubcategoriafinal(selectSub.value);
          console.log(categoriasFinal)
          categoriasFinal.forEach(final => {
          
          option = document.createElement('option');
          option.value = final.nome;
          option.innerText = final.nome;
          selectFinal.appendChild(option);
        })
        }
        prt = await produtosSelect(select.value, selectSub.value , selectFinal.value);
        renderizarProdutos(prt.flat());
        // function produtosSelecionados(nomeCategoria, nomeSubcategoria, nomeSubcategoriaFinal) {
        //   try {
        //     if(typeof nomeCategoria !== 'string' || typeof nomeSubcategoria !== 'string' || typeof nomeSubcategoriaFinal !== 'string'){
        //       throw new Error("todos os parâmetros precisam ser do tipo 'string'");
        //     }
        //   } catch (error) {
        //     console.log("Erro na função produtos selecionados, erro: "+ error)
        //   }
        // }
      })
      selectFinal.addEventListener('change', async ()=>{
        prt = await produtosSelect(select.value, selectSub.value , selectFinal.value);
        renderizarProdutos(prt.flat());
      })
    }
  </script>

  <!--script para fazer o header funcionar e html do modal-->
      <div id="meuModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h2 id="modal-txt">Login como:</h2>
            <button id="fornecedor">Fornecedor</button>
            <button id="usuario">Usuário</button>
        </div>
    </div>
      <script>
        initSearchbar();
        initHeader();
        async function initSearchbar() {
            searchbar = document.getElementById('input');
            let sugestoes = document.getElementsByClassName('sugestoes')[0];
            let results = null;
            searchbar.addEventListener('input', async () => {
                sugestoes.innerHTML = "";
                if (searchbar.value !== null && searchbar.value !== "") {
                    results = await produtoNomeLike(searchbar.value)
                }
                results.forEach(prod => {
                    li = document.createElement('li');
                    li.innerText = prod.nome;
                    li.addEventListener('click', () => {
                        searchbar.value = "";
                        window.location = "cotacao.html?produto=" + prod.id;
                    })
                    sugestoes.appendChild(li);
                });

                console.log(results);
            })
            icon = document.getElementsByClassName('fas fa-search')[0];
            icon.addEventListener('click', () => {
                window.location = "catalogo.html?search=" + searchbar.value
            })
        }
        function initHeader() {
            logout = document.getElementById('logout');
            cart = document.getElementById('cart');
            dashboard = document.getElementById('dashboard');
            loginTxt = document.getElementById('login');
            cadastroTxt = document.getElementById('cadastro');
            btnFornecedor = document.getElementById('fornecedor');
            btnUsuario = document.getElementById('usuario');
            txtModal = document.getElementById('modal-txt');
            perfil = document.getElementById('perfil');
            modal = document.getElementsByClassName('modal')[0];
                    document.addEventListener("DOMContentLoaded", function () {
            const userIcon = document.getElementById("user-icon");
            const dropdownMenu = document.getElementById("dropdown-menu");

            userIcon.addEventListener("click", function (event) {
                event.stopPropagation();
                dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
            });

            document.addEventListener("click", function () {
                dropdownMenu.style.display = "none";
            });

            dropdownMenu.addEventListener("click", function (event) {
                event.stopPropagation();
            });
        });
            logout.addEventListener('click', () => {

                if (sessionStorage.getItem('token') == null) {
                    alert("Você não está logado!")
                } else {
                    sessionStorage.removeItem('token');
                    alert("Você deslogou com sucesso!")
                    window.location = "landingPage.html"
                }
            })
            perfil.addEventListener('click', async () => {
                    token = sessionStorage.getItem('token');
                    if (token != null) {
                        obj = await decodificarJWT(token);

                        fornecedor = await getFornecedorByEmail(obj.sub);
                        if (fornecedor == null) {
                            window.location = "PerfilFornecedor.html";
                        } else {
                            window.location = "PerfilUsuario.html";
                        }
                    } else {
                        alert("Você precisa estar logado")
                    }
            })
            dashboard.addEventListener('click', async () => {
                if (sessionStorage.getItem('token' == null)) {
                    alert("Você precisa estar logado");
                } else {
                    token = sessionStorage.getItem('token');
                    if (token != null) {
                        obj = await decodificarJWT(token);

                        fornecedor = await getFornecedorByEmail(obj.sub);
                        if (fornecedor == null) {
                            window.location = "dashboard.html";
                        } else {
                            window.location = "dashboardusuario.html";
                        }
                    } else {
                        alert("Você precisa estar logado")
                    }

                }
            })
            cart.addEventListener('click', () => {
                if (sessionStorage.getItem('token') == null) {
                    alert("Você precisa estar logado");
                } else {
                    window.location = "carrinho.html";
                }
            })

            loginTxt.addEventListener('click', () => {
                txtModal.innerText = "login como:"
                modal.style.display = 'block';
                btnFornecedor.addEventListener('click', () => {
                    window.location = "loginFornecedor.html";
                })
                btnUsuario.addEventListener('click', () => {
                    window.location = "login.html"
                })
            })
            cadastroTxt.addEventListener('click', () => {
                txtModal.innerText = "Cadastrar-se como:"
                modal.style.display = 'block';
                btnFornecedor.addEventListener('click', () => {
                    window.location = "cadastroFornecedor.html"
                })
                btnUsuario.addEventListener('click', () => {
                    window.location = "cadastroUsuario.html"
                })
            })

        }
        function fecharModal() {
            modal.style.display = "none";
        }
    </script>

</body>
</html>

