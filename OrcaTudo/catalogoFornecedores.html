<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalogo de Fornecedores</title>
  <script src="https://kit.fontawesome.com/449a3898b7.js" crossorigin="anonymous"></script>
  <link rel="icon" href="imagens/Logo1.png" type="image/png">
  <link rel="stylesheet" href="css/catalogoFornecedores.css">
  <link rel="stylesheet" href="css/header.css">
</head>

<body>

    <header>
        <div class="logo">
            <img src="imagens/Logo1.png" alt="Logo OrçaTudo">
        </div>

        <div class="search-bar">
            <div>
                <input id="input" type="text" placeholder="O que você procura na Orça Tudo?">
                <i class="fas fa-search" id="search"></i>
            </div>
            <ul class="sugestoes">
            </ul>
        </div>

        <nav>
            <ul>
                <li><a href="catalogo.html">Catálogo</a></li>
                <li><a id="dashboard">Dashboard</a></li>
            </ul>
        </nav>

        <div class="icons">
            <p id="cadastro">Cadastre-se</p>
            <p id="login">Faça login</p>
            <div class="user-menu">
                <i class="far fa-user" id="user-icon"></i>
                <div class="dropdown-menu" id="dropdown-menu">
                    <a id="perfil">Perfil</a>
                    
                    <a id="logout">Sair da Conta</a>
                </div>
            </div>
            <i class="fas fa-shopping-cart" id="cart"></i>
        </div>
    </header>


  <container>


    <div class="mainContent">

      <section class="perfil-fornecedor">
        <div class="perfil-img">
          <img src="imagens/userPlaceholder.png" alt="Foto do Fornecedor">
        </div>

        <div class="perfil-info">
          <h2 class="perfil-nome">Nome do Fornecedor</h2>
          <h4 class="perfil-area">Area de atuação</h4>
          <h4 class="perfil-endereco">endereço</h4>
          <p class="perfil-razao">Razão Social</p>
          <p class="perfil-contato">Contato: emailexemplo@gmail.com</p>

        </div>

        <div class="perfil-sobre">
          <h3>Sobre nós</h3>
          <p>
            Somos uma empresa focada em qualidade, inovação e compromisso com nossos clientes.
            Oferecemos soluções eficientes e personalizadas, sempre com ética e transparência.
            Nossa equipe qualificada trabalha para entregar resultados que fazem a diferença,
            garantindo excelência em cada projeto e construindo relações de confiança.
          </p>
        </div>
      </section>


      <section class="catalogo-section">
        <!-- Filtro -->
        <div class="filtro-container">
          <label for="filtro">Filtrar por</label>
          <select id="filtro" class="filtro-selecao">
            <option value="relevante">Mais relevante</option>
            <option value="maior_preco">Maior preço</option>
            <option value="menor_preco">Menor preço</option>
          </select>
        </div>

        <!-- Categorias -->
        <p style="margin-bottom: 10px;" >Subcategorias:</p>
        <div class="categoria-lista">
          <span class="categoria-item">Categoria 1</span>
          <span class="categoria-item">Categoria 2</span>
          <span class="categoria-item">Categoria 3</span>
          <span class="categoria-item">Categoria 4</span>
        </div>
      </section>

      <section class="produto-section">
        <div class="produto-card">
          <img
            src="https://cdn.leroymerlin.com.br/products/carrinho_de_mao_em_aco_carbono_pneu_e_camara_chapa_26mm_45l_1571958082_5aac_300x300.jpg"
            alt="Produto" />
          <h3> Carrinho De Mão Em Aço </h3>
          <p class="preco">R$ 189,91</p>
          <p class="categoria"> Ferramentas e Equipamentos</p>
          <p class="subcategoria">Carrinhos de Mão</p>
        </div>


        <!-- repete os cards -->

        <div class="produto-card">
          <img
            src="https://cdn.leroymerlin.com.br/products/betoneira_400l_1_traco_max_mono_127v_csm_92016435_f57f_600x600.jpg"
            alt="Produto" />
          <h3> Betoneira 400L 1 Traço </h3>
          <p class="preco">R$ 4.589,00</p>
          <p class="categoria"> Categoria </p>
          <p class="subcategoria"> Sub Categoria </p>
        </div>

        <div class="produto-card">
          <img
            src="https://cdn.leroymerlin.com.br/products/trena_manual_5mx19mm_460610_dexter_91716401_b391_600x600.jpg"
            alt="Produto" />
          <h3> Trena Manual 5 metros </h3>
          <p class="preco">R$ 29,90</p>
          <p class="categoria"> Categoria </p>
          <p class="subcategoria"> Sub Categoria </p>
        </div>

        <div class="produto-card">
          <img src="imagens/placeholder.jpg" alt="Produto" />
          <h3> Nome Produto </h3>
          <p class="preco">R$ 00,00</p>
          <p class="categoria"> Categoria </p>
          <p class="subcategoria"> Sub Categoria </p>
        </div>

        <div class="produto-card">
          <img src="imagens/placeholder.jpg" alt="Produto" />
          <h3> Nome Produto </h3>
          <p class="preco">R$ 00,00</p>
          <p class="categoria"> Categoria </p>
          <p class="subcategoria"> Sub Categoria </p>
        </div>

        <div class="produto-card">
          <img src="imagens/placeholder.jpg" alt="Produto" />
          <h3> Nome Produto </h3>
          <p class="preco">R$ 00,00</p>
          <p class="categoria"> Categoria </p>
          <p class="subcategoria"> Sub Categoria </p>
        </div>

        <div class="produto-card">
          <img src="imagens/placeholder.jpg" alt="Produto" />
          <h3> Nome Produto </h3>
          <p class="preco">R$ 00,00</p>
          <p class="categoria"> Categoria </p>
          <p class="subcategoria"> Sub Categoria </p>
        </div>

        <div class="produto-card">
          <img src="imagens/placeholder.jpg" alt="Produto" />
          <h3> Nome Produto </h3>
          <p class="preco">R$ 00,00</p>
          <p class="categoria"> Categoria </p>
          <p class="subcategoria"> Sub Categoria </p>
        </div>

        <div class="produto-card">
          <img src="imagens/placeholder.jpg" alt="Produto" />
          <h3> Nome Produto </h3>
          <p class="preco">R$ 00,00</p>
          <p class="categoria"> Categoria </p>
          <p class="subcategoria"> Sub Categoria </p>
        </div>



      </section>

  </container>



  <footer>
    <div class="footer-container">
      <div class="footer-section">
        <img src="imagens/Logo.png" alt="OrçaTudo Logo" class="footer-logo">
      </div>
      <div class="footer-section">
        <h3>Ideal Para</h3>
        <ul>
          <li>Engenheiros Civis</li>
          <li>Construtoras</li>
          <li>Orçamentistas</li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Funcionalidades</h3>
        <ul>
          <li>Cotação de Preços</li>
          <li>Gestão de Orçamentos</li>
          <li>Comparação de Materiais</li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Recursos</h3>
        <ul>
          <li>Lista de Fornecedores</li>
          <li>Simulação de Custos</li>
          <li>Dashboard Interativo</li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Sobre</h3>
        <ul>
          <li><a href="#">Sobre o OrçaTudo</li>
          <li><a href="#">Contato</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>© 2025 OrçaTudo. Todos os direitos reservados | Política de Privacidade | Termos de Serviço</p>
    </div>
  </footer>


  <!--script para funcionamento do header e html do modal-->
  <div id="meuModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h2 id="modal-txt">Login como:</h2>
      <button id="fornecedor">Fornecedor</button>
      <button id="usuario">Usuário</button>
    </div>
  </div>
  <script src="js/produto.js"></script>
  <script src="js/authUsuario.js"></script>
  <script src="js/Fornecedor.js"></script>
  <script src="js/subcategoria.js"></script>
  <script src="js/SubcategoriaFinal.js"></script>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
            const userIcon = document.getElementById("user-icon");
            const dropdownMenu = document.getElementById("dropdown-menu");

            userIcon.addEventListener("click", function (event) {
                event.stopPropagation();
                dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
            });

            document.addEventListener("click", function () {
                dropdownMenu.style.display = "none";
            });

            dropdownMenu.addEventListener("click", function (event) {
                event.stopPropagation();
            });
        });
    </script>
    <script>
        initSearchbar();
        initHeader();
        async function initSearchbar() {
            searchbar = document.getElementById('input');
            let sugestoes = document.getElementsByClassName('sugestoes')[0];
            let results = null;
            searchbar.addEventListener('input', async () => {
                sugestoes.innerHTML = "";
                if (searchbar.value !== null && searchbar.value !== "") {
                    results = await produtoNomeLike(searchbar.value)
                }
                results.forEach(prod => {
                    li = document.createElement('li');
                    li.innerText = prod.nome;
                    li.addEventListener('click', () => {
                        searchbar.value = "";
                        window.location = "cotacao.html?produto=" + prod.id;
                    })
                    sugestoes.appendChild(li);
                });

                console.log(results);
            })
            icon = document.getElementsByClassName('fas fa-search')[0];
            icon.addEventListener('click', () => {
                window.location = "catalogo.html?search=" + searchbar.value
            })
        }
        function initHeader() {
            logout = document.getElementById('logout');
            cart = document.getElementById('cart');
            dashboard = document.getElementById('dashboard');
            loginTxt = document.getElementById('login');
            cadastroTxt = document.getElementById('cadastro');
            btnFornecedor = document.getElementById('fornecedor');
            btnUsuario = document.getElementById('usuario');
            txtModal = document.getElementById('modal-txt');
            perfil = document.getElementById('perfil');
            modal = document.getElementsByClassName('modal')[0];
            logout.addEventListener('click', () => {

                if (sessionStorage.getItem('token') == null) {
                    alert("Você não está logado!")
                } else {
                    sessionStorage.removeItem('token');
                    alert("Você deslogou com sucesso!")
                    window.location = "landingPage.html"
                }
            })
            perfil.addEventListener('click', async () => {
                    token = sessionStorage.getItem('token');
                    if (token != null) {
                        obj = await decodificarJWT(token);

                        fornecedor = await getFornecedorByEmail(obj.sub);
                        if (fornecedor == null) {
                            window.location = "PerfilFornecedor.html";
                        } else {
                            window.location = "PerfilUsuario.html";
                        }
                    } else {
                        alert("Você precisa estar logado")
                    }
            })
            dashboard.addEventListener('click', async () => {
                if (sessionStorage.getItem('token' == null)) {
                    alert("Você precisa estar logado");
                } else {
                    token = sessionStorage.getItem('token');
                    if (token != null) {
                        obj = await decodificarJWT(token);

                        fornecedor = await getFornecedorByEmail(obj.sub);
                        if (fornecedor == null) {
                            window.location = "dashboard.html";
                        } else {
                            window.location = "dashboardusuario.html";
                        }
                    } else {
                        alert("Você precisa estar logado")
                    }

                }
            })
            cart.addEventListener('click', () => {
                if (sessionStorage.getItem('token') == null) {
                    alert("Você precisa estar logado");
                } else {
                    window.location = "carrinho.html";
                }
            })

            loginTxt.addEventListener('click', () => {
                txtModal.innerText = "login como:"
                modal.style.display = 'block';
                btnFornecedor.addEventListener('click', () => {
                    window.location = "loginFornecedor.html";
                })
                btnUsuario.addEventListener('click', () => {
                    window.location = "login.html"
                })
            })
            cadastroTxt.addEventListener('click', () => {
                txtModal.innerText = "Cadastrar-se como:"
                modal.style.display = 'block';
                btnFornecedor.addEventListener('click', () => {
                    window.location = "cadastroFornecedor.html"
                })
                btnUsuario.addEventListener('click', () => {
                    window.location = "cadastroUsuario.html"
                })
            })

        }
        function fecharModal() {
            modal.style.display = "none";
        }
    </script>
  <!--Script para integração da página -->
  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      params = new URLSearchParams(window.location.search);
      let fornecedor;
      if (params.get('fornecedor') == null) {
        //caso a página não tenha o parâmetro 'fornecedor'
        alert('Parâmetro obrigatório "fornecedor" ausente');
      } else {
        //caso a página tenha o parâmetro 'fornecedor'
        fornecedor = await getFornecedorById(Number.parseInt(params.get('fornecedor')));
        if (fornecedor == null) {
          alert("Parâmetro 'fornecedor' inválido");
        }
        carregarInfoFornecedor(fornecedor)
        produtos = await getProdutoByFornecedorNome(fornecedor[0].nome)
        carregarFiltro(produtos);
        carregarProdutos(produtos);
      }
    })

    function carregarProdutos(produtos){
      console.log("carregarProdutos rodou!")
      if(!Array.isArray(produtos) || produtos == null ){
        throw new Error("O parâmetro 'produtos' da função carregarProdutos precisa ser um Array e não pode ser nulo"); 
      }
      const cardsContainer = document.getElementsByClassName('produto-section')[0];
      cardsContainer.innerHTML = "";
      produtos.forEach(produto => {
        const cardDiv = document.createElement('div');
        cardDiv.classList.add('produto-card')
        cardDiv.addEventListener('click', ()=>{
          window.location = "cotacao.html?produto=" + produto.id;
        })
        const cardImg = document.createElement('img');
        const cardH3 = document.createElement('h3');
        const cardPreco = document.createElement('p');
        cardPreco.classList.add('preco');
        const cardCategoria = document.createElement('p');
        cardCategoria.classList.add('categoria')
        const cardSubcategoria = document.createElement('p');
        cardSubcategoria.classList.add('subcategoria')
        
        const base64 = produto.imagem;
        const contentType = "image/png";
        const dataUrl = `data:${contentType};base64,${base64}`;
        cardImg.src = dataUrl
        cardDiv.appendChild(cardImg);
        cardH3.innerText = produto.nome;
        cardDiv.appendChild(cardH3);
        cardPreco.innerText =  "R$ "+ produto.preco;
        cardDiv.appendChild(cardPreco);
        cardCategoria.innerText = produto.subcategoriaFinal.subcategoria.categoria.nome;
        cardDiv.appendChild(cardCategoria);
        cardSubcategoria.innerText = produto.subcategoriaFinal.subcategoria.nome;
        cardDiv.appendChild(cardSubcategoria);
        cardsContainer.appendChild(cardDiv);

      })
    }
    function carregarInfoFornecedor(fornecedor) {
      console.log(fornecedor);
      const nomeFornecedor = document.getElementsByClassName('perfil-nome')[0];
      const areaFornecedor = document.getElementsByClassName('perfil-area')[0];
      const contatoFornecedor = document.getElementsByClassName('perfil-contato')[0];
      const razaoFornecedor = document.getElementsByClassName('perfil-razao')[0];
      const enderecoFornecedor = document.getElementsByClassName('perfil-endereco')[0];
      const sobreFornecedor = document.getElementsByClassName('perfil-sobre')[0];


      nomeFornecedor.innerText = fornecedor[0].nome;
      areaFornecedor.innerText = fornecedor[0].area_de_atuacao;
      contatoFornecedor.innerText = "Contato: " + fornecedor[0].email;
      razaoFornecedor.innerText = fornecedor[0].razao_social;
      enderecoFornecedor.innerText = "Logradouro: " + fornecedor[0].endereco;
      sobreFornecedor.innerHTML = "<h3>Sobre nós</h3>" + "<p>" + fornecedor[0].descricao + "</p>";
    }
    function carregarFiltro(produtos) {
      let categorias = [];
      let subcategorias = [];
      let subFinais = [];
      selectFiltro = document.getElementById('filtro');
      divSubcategorias = document.getElementsByClassName('categoria-lista')[0];
      produtos.forEach(produto => {

        if (!subFinais.includes(produto.subcategoriaFinal.nome)) {
          subFinais.push(produto.subcategoriaFinal.nome);
        }
        if (!subcategorias.includes(produto.subcategoriaFinal.subcategoria.nome)) {
          subcategorias.push(produto.subcategoriaFinal.subcategoria.nome);
        }
        if (!categorias.includes(produto.subcategoriaFinal.subcategoria.categoria.nome)) {
          categorias.push(produto.subcategoriaFinal.subcategoria.categoria.nome);
        }
      })

      //select de categorias
      selectFiltro.innerText = "";
      categorias.forEach(categoria => {
        option = document.createElement('option');
        option.innerText = categoria;
        selectFiltro.appendChild(option);
      })
      selectFiltro.addEventListener('change', async ()=>{
        if(selectFiltro.value !== ""){
          console.log(selectFiltro.value)
          subcategorias = await getSubcategoria(selectFiltro.value);
          subFinal = await Promise.all(subcategorias.flat().map(sub => getSubcategoriafinal(sub.nome)));
          produtos = await Promise.all(subFinal.flat().map(final => getProdutoByCategoriaFinal(final.nome)));
          carregarProdutos(produtos.flat());
        }
        
      })
      selectFiltro.innerHTML += "<option value='' selected disabled >Selecionar categoria</option>";
      //botões para filtrar por subcategorias
      divSubcategorias.innerText = "";
      subcategorias.forEach(subcategoria => {
        span = document.createElement('span');
        span.innerText = subcategoria;
        span.classList.add('categoria-item');
        span.addEventListener('click', async ()=>{
          subFinal = await getSubcategoriafinal(subcategoria);
          produtos = await Promise.all(subFinal.map(final => getProdutoByCategoriaFinal(final.nome)));
          carregarProdutos(produtos.flat())
        })
        divSubcategorias.appendChild(span);
      })


      console.log("categorias: ", categorias);
      console.log("subcategorias: ", subcategorias);
      console.log("Subcateogiras finais: ", subFinais);
    }
  </script>
</body>

</html>